#include "ssd1306.h"
#include <stdio.h>
#include <stdlib.h>
#include "systick.h"
#include "stm32f0xx.h"
#include "pins.h"
#include "stm32f0xx_ll_i2c.h"
#include "debug.h"
#include "timer.h"

extern volatile unsigned char buffer[128 * 8];

void ssd1306_rst_init(void)
{
    LL_AHB1_GRP1_EnableClock(DISP_RST_CLOCK);
    LL_GPIO_InitTypeDef GPIO_InitStruct;

    GPIO_InitStruct.Pin = DISP_RST_PIN;
    GPIO_InitStruct.Mode = LL_GPIO_MODE_OUTPUT;
    GPIO_InitStruct.Pull = LL_GPIO_PULL_UP;
    GPIO_InitStruct.Speed = LL_GPIO_SPEED_FREQ_HIGH;
    LL_GPIO_Init(DISP_RST_PORT, &GPIO_InitStruct);
}

void ssd1306_rst(void)
{
    struct timer tim;
    LL_GPIO_ResetOutputPin(DISP_RST_PORT, DISP_RST_PIN);
    timer_set(&tim, 200);
    while (!timer_expired(&tim));
    LL_GPIO_SetOutputPin(DISP_RST_PORT, DISP_RST_PIN);
    timer_restart(&tim);
    while (!timer_expired(&tim));
    LL_GPIO_ResetOutputPin(DISP_RST_PORT, DISP_RST_PIN);
    timer_restart(&tim);
    while (!timer_expired(&tim));
    LL_GPIO_SetOutputPin(DISP_RST_PORT, DISP_RST_PIN);
    timer_restart(&tim);
    while (!timer_expired(&tim));
}

void ssd1306_init(void)
{
    const uint8_t ssd1306_init_sequence [] = {// Initialization Sequence
        0xAE, // Display OFF (sleep mode)
        0x20, 0b00, // Set Memory Addressing Mode
        // 00=Horizontal Addressing Mode; 01=Vertical Addressing Mode;
        // 10=Page Addressing Mode (RESET); 11=Invalid
        0xB0, // Set Page Start Address for Page Addressing Mode, 0-7
        0xC8, // Set COM Output Scan Direction
        0x00, // ---set low column address
        0x10, // ---set high column address
        0x40, // --set start line address
        0x81, 0x3F, // Set contrast control register
        0xA1, // Set Segment Re-map. A0=address mapped; A1=address 127 mapped.
        0xA6, // Set display mode. A6=Normal; A7=Inverse
        0xA8, 0x3F, // Set multiplex ratio(1 to 64)
        0xA4, // Output RAM to Display
        // 0xA4=Output follows RAM content; 0xA5,Output ignores RAM content
        0xD3, 0x00, // Set display offset. 00 = no offset
        0xD5, // --set display clock divide ratio/oscillator frequency
        0xF0, // --set divide ratio
        0xD9, 0x22, // Set pre-charge period
        0xDA, 0x12, // Set com pins hardware configuration
        0xDB, // --set vcomh
        0x20, // 0x20,0.77xVcc
        0x8D, 0x14, // Set DC-DC enable
        0xAF // Display ON in normal mode
    };

    for (uint32_t i = 0; i<sizeof (ssd1306_init_sequence); i++) {
        OLED_send_cmd(ssd1306_init_sequence[i]);
    }
}

void OLED_SetContrast(uint8_t contrast)
{
    OLED_send_cmd(0x81); // Set contrast control register
    OLED_send_cmd(contrast);
}

void OLED_send_cmd(uint8_t cmd)
{
    while (LL_I2C_IsActiveFlag_BUSY(I2C) != RESET);
    LL_I2C_HandleTransfer(I2C, OLED_ADDRESS, LL_I2C_ADDRSLAVE_7BIT, 2, LL_I2C_MODE_AUTOEND, LL_I2C_GENERATE_START_WRITE);

    while (LL_I2C_IsActiveFlag_TXIS(I2C) == RESET);
    LL_I2C_TransmitData8(I2C, 0x00);

    while (LL_I2C_IsActiveFlag_TXIS(I2C) == RESET);
    LL_I2C_TransmitData8(I2C, cmd);

    while (LL_I2C_IsActiveFlag_STOP(I2C) == RESET);
    LL_I2C_ClearFlag_STOP(I2C);
}

void ssd1306_Update_display(void)
{
    unsigned int x, i, p;
    x = 0;
    for (p = 0; p < 8; p++) {
        OLED_send_cmd(0xB0 | p);
        OLED_send_cmd(0x00 + ((0x10 & 0x0F)*16 + 0x00) % 16);
        OLED_send_cmd(0x10 + ((0x10 & 0x0F)*16 + 0x00) / 16);

        while (LL_I2C_IsActiveFlag_BUSY(I2C) != RESET);
        LL_I2C_HandleTransfer(I2C, OLED_ADDRESS, LL_I2C_ADDRSLAVE_7BIT, 129, LL_I2C_MODE_AUTOEND, LL_I2C_GENERATE_START_WRITE);

        while (LL_I2C_IsActiveFlag_TXIS(I2C) == RESET);
        LL_I2C_TransmitData8(I2C, 0x40);


        for (i = 0; i < 128; i++) {
            while (LL_I2C_IsActiveFlag_TXIS(I2C) == RESET);
            LL_I2C_TransmitData8(I2C, buffer[x++]);
        }

        while (LL_I2C_IsActiveFlag_STOP(I2C) == RESET);
        LL_I2C_ClearFlag_STOP(I2C);
    }
}

const uint32_t picture_wifi[40] = {4177526559, 100663392, 33554496, 16777344, 16777344, 16777344, 19923072, 18350208, 17563776, 17171072, 16974720, 2172715392, 3250585728, 3244306560, 3244300416, 1630541952, 1630538880, 1628966022, 823658127, 823690911, 823690911, 823658127, 1628966022, 1630538880, 1630541952, 3244300416, 3244306560, 3250585728, 2172715392, 16974720, 17171072, 17563776, 18350208, 19923072, 16777344, 16777344, 16777344, 33554496, 100663392, 4177526559};
const uint32_t picture_wifi_i[40] = {4177526559, 4278189951, 4278189951, 4294967295, 4294967295, 4294967295, 4291821567, 4293394431, 4294180863, 4294573567, 4294769919, 2139029247, 1061158911, 1067438079, 1067444223, 2681202687, 2681205759, 2682778617, 3488086512, 3488053728, 3488053728, 3488086512, 2682778617, 2681205759, 2681202687, 1067444223, 1067438079, 1061158911, 2139029247, 4294769919, 4294573567, 4294180863, 4293394431, 4291821567, 4294967295, 4294967295, 4294967295, 4278189951, 4278189951, 4177526559};

const uint32_t picture_settings[40] = {4177526559, 100663392, 33554496, 16777344, 16777344, 16777344, 16777344, 2164719772, 2165047442, 2165309585, 18972808, 958546052, 1229201538, 2302939265, 423856256, 289424512, 562046080, 3238009216, 17760896, 17826944, 18876544, 21500032, 26484864, 19087744, 2168488576, 1092617345, 554698882, 286265476, 151527560, 151273616, 285376656, 553713817, 3238002830, 16777344, 16777344, 16777344, 16777344, 33554496, 100663392, 4177526559};
const uint32_t picture_settings_i[40] = {4177526559, 4278189951, 4278189951, 4294967295, 4294967295, 4294967295, 4294967295, 2147024867, 2146697197, 2146435054, 4292771831, 3353198587, 3082543101, 2008805374, 3887888383, 4022320127, 3749698559, 1073735423, 4293983743, 4293917695, 4292868095, 4290244607, 4285259775, 4292656895, 2143256063, 3219127294, 3757045757, 4025479163, 4160217079, 4160471023, 4026367983, 3758030822, 1073741809, 4294967295, 4294967295, 4294967295, 4294967295, 4278189951, 4278189951, 4177526559};

const uint32_t picture_output[40] = {4177526559, 100663392, 33554496, 16777344, 16777344, 16777344, 16777344, 29361024, 33038208, 33456000, 20970624, 2164777089, 3238101123, 2164260999, 16777351, 16777358, 16777358, 16777358, 4177985692, 4177985692, 4177985692, 4177985692, 16777358, 16777358, 16777358, 16777351, 2164260999, 3238101123, 2164777089, 20970624, 33456000, 33038208, 29361024, 16777344, 16777344, 16777344, 16777344, 33554496, 100663392, 4177526559};
const uint32_t picture_output_i[40] = {4177526559, 4278189951, 4278189951, 4294967295, 4294967295, 4294967295, 4294967295, 4282383615, 4278706431, 4278288639, 4290774015, 2146967550, 1073643516, 2147483640, 4294967288, 4294967281, 4294967281, 4294967281, 133758947, 133758947, 133758947, 133758947, 4294967281, 4294967281, 4294967281, 4294967288, 2147483640, 1073643516, 2146967550, 4290774015, 4278288639, 4278706431, 4282383615, 4294967295, 4294967295, 4294967295, 4294967295, 4278189951, 4278189951, 4177526559};

const uint32_t picture_backarrow[40] = {4177526559, 100663392, 33554496, 16777344, 16777344, 16777344, 16777344, 16777344, 16777344, 16777344, 16777344, 16924800, 17293440, 2165301376, 3240091776, 3779059840, 4051689600, 17293440, 17293440, 17293440, 17293440, 17293440, 17293440, 17821824, 18872448, 25067136, 33308544, 33038208, 31459200, 16777344, 16777344, 16777344, 16777344, 16777344, 16777344, 16777344, 16777344, 33554496, 100663392, 4177526559};
const uint32_t picture_backarrow_i[40] = {4177526559, 4278189951, 4278189951, 4294967295, 4294967295, 4294967295, 4294967295, 4294967295, 4294967295, 4294967295, 4294967295, 4294819839, 4294451199, 2146443263, 1071652863, 532684799, 260055039, 4294451199, 4294451199, 4294451199, 4294451199, 4294451199, 4294451199, 4293922815, 4292872191, 4286677503, 4278436095, 4278706431, 4280285439, 4294967295, 4294967295, 4294967295, 4294967295, 4294967295, 4294967295, 4294967295, 4294967295, 4278189951, 4278189951, 4177526559};

const uint32_t picture_measuring[40] = {4177526559, 100663392, 33554496, 16777344, 16777344, 16777344, 16777344, 16777360, 16793744, 16810128, 16810384, 16777856, 16778368, 16777344, 17039488, 17301632, 17825920, 18940032, 16908416, 17563776, 1091567744, 2166358144, 29425792, 16777600, 16777856, 16780416, 285216896, 1627398272, 16826496, 16777357, 16777362, 16777362, 2030043276, 16777344, 16777344, 16777344, 16777344, 33554496, 100663392, 4177526559};
const uint32_t picture_measuring_i[40] = {4177526559, 4278189951, 4278189951, 4294967295, 4294967295, 4294967295, 4294967295, 4294967279, 4294950895, 4294934511, 4294934255, 4294966783, 4294966271, 4294967295, 4294705151, 4294443007, 4293918719, 4292804607, 4294836223, 4294180863, 3220176895, 2145386495, 4282318847, 4294967039, 4294966783, 4294964223, 4026527743, 2684346367, 4294918143, 4294967282, 4294967277, 4294967277, 2281701363, 4294967295, 4294967295, 4294967295, 4294967295, 4278189951, 4278189951, 4177526559};

const uint32_t picture_brightness[40] = {4177526559, 100663392, 33554496, 16777344, 16777344, 16777344, 25166208, 25166208, 830472588, 1904214414, 3774873735, 3250586499, 32513920, 20724864, 17723520, 17195136, 17023104, 17023104, 2164359297, 3179381181, 3179381181, 2164359297, 17023104, 17023104, 17195136, 17723520, 20724864, 32509824, 3250586499, 3774873735, 1904214414, 830472588, 25166208, 25166208, 16777344, 16777344, 16777344, 33554496, 100663392, 4177526559};
const uint32_t picture_brightness_i[40] = {4177526559, 4278189951, 4278189951, 4294967295, 4294967295, 4294967295, 4286578431, 4286578431, 3481272051, 2407530225, 536870904, 1061158140, 4279230719, 4291019775, 4294021119, 4294549503, 4294721535, 4294721535, 2147385342, 1132363458, 1132363458, 2147385342, 4294721535, 4294721535, 4294549503, 4294021119, 4291019775, 4279234815, 1061158140, 536870904, 2407530225, 3481272051, 4286578431, 4286578431, 4294967295, 4294967295, 4294967295, 4278189951, 4278189951, 4177526559};

const uint32_t picture_minus[40] = {4177526559, 100663392, 33554496, 16777344, 16777344, 16777344, 16777344, 16777344, 25166208, 29361024, 29361024, 29361024, 29361024, 29361024, 29361024, 29361024, 29361024, 29361024, 29361024, 29361024, 29361024, 29361024, 29361024, 29361024, 29361024, 29361024, 29361024, 29361024, 29361024, 29361024, 29361024, 25166208, 16777344, 16777344, 16777344, 16777344, 16777344, 33554496, 100663392, 4177526559};
const uint32_t picture_minus_i[40] = {4177526559, 4278189951, 4278189951, 4294967295, 4294967295, 4294967295, 4294967295, 4294967295, 4286578431, 4282383615, 4282383615, 4282383615, 4282383615, 4282383615, 4282383615, 4282383615, 4282383615, 4282383615, 4282383615, 4282383615, 4282383615, 4282383615, 4282383615, 4282383615, 4282383615, 4282383615, 4282383615, 4282383615, 4282383615, 4282383615, 4282383615, 4286578431, 4294967295, 4294967295, 4294967295, 4294967295, 4294967295, 4278189951, 4278189951, 4177526559};

const uint32_t picture_plus[40] = {4177526559, 100663392, 33554496, 16777344, 16777344, 16777344, 16777344, 16777344, 25166208, 29361024, 29361024, 29361024, 29361024, 29361024, 29361024, 29361024, 29361024, 29361024, 3791650695, 4060086159, 4060086159, 3791650695, 29361024, 29361024, 29361024, 29361024, 29361024, 29361024, 29361024, 29361024, 29361024, 25166208, 16777344, 16777344, 16777344, 16777344, 16777344, 33554496, 100663392, 4177526559};
const uint32_t picture_plus_i[40] = {4177526559, 4278189951, 4278189951, 4294967295, 4294967295, 4294967295, 4294967295, 4294967295, 4286578431, 4282383615, 4282383615, 4282383615, 4282383615, 4282383615, 4282383615, 4282383615, 4282383615, 4282383615, 520093944, 251658480, 251658480, 520093944, 4282383615, 4282383615, 4282383615, 4282383615, 4282383615, 4282383615, 4282383615, 4282383615, 4282383615, 4286578431, 4294967295, 4294967295, 4294967295, 4294967295, 4294967295, 4278189951, 4278189951, 4177526559};

const uint32_t picture_display[40] = {4177526559, 100663392, 33554496, 3791650695, 285343880, 285343880, 285343880, 285343880, 300056456, 287457416, 287457416, 287457416, 287457416, 289546376, 293740424, 285343880, 300056456, 285343880, 297939080, 287457672, 287457928, 287458440, 287459464, 297939080, 285343880, 300056456, 287442056, 287442056, 287442056, 287442056, 289538696, 293732744, 285343880, 285343880, 285343880, 285343880, 3791650695, 33554496, 100663392, 4177526559};
const uint32_t picture_display_i[40] = {4177526559, 4278189951, 4278189951, 520093944, 4026400759, 4026400759, 4026400759, 4026400759, 4011688183, 4024287223, 4024287223, 4024287223, 4024287223, 4022198263, 4018004215, 4026400759, 4011688183, 4026400759, 4013805559, 4024286967, 4024286711, 4024286199, 4024285175, 4013805559, 4026400759, 4011688183, 4024302583, 4024302583, 4024302583, 4024302583, 4022205943, 4018011895, 4026400759, 4026400759, 4026400759, 4026400759, 520093944, 4278189951, 4278189951, 4177526559};

const uint32_t picture_leds[40] = {4177526559, 100663392, 33554496, 2181037953, 2181037953, 16810113, 16810113, 16810113, 16810113, 16810113, 16810113, 16810113, 16810113, 16777344, 16777344, 2181037953, 2181037953, 2172748161, 2172748161, 2172748161, 2172748161, 2172748161, 2172748161, 2164359297, 2164359297, 16777344, 16777344, 2181037953, 2181037953, 2164359297, 2164359297, 2164359297, 2164359297, 17023104, 17293440, 33456000, 33038208, 33554496, 100663392, 4177526559};
const uint32_t picture_leds_i[40] = {4177526559, 4278189951, 4278189951, 2130706686, 2130706686, 4294934526, 4294934526, 4294934526, 4294934526, 4294934526, 4294934526, 4294934526, 4294934526, 4294967295, 4294967295, 2130706686, 2130706686, 2138996478, 2138996478, 2138996478, 2138996478, 2138996478, 2138996478, 2147385342, 2147385342, 4294967295, 4294967295, 2130706686, 2130706686, 2147385342, 2147385342, 2147385342, 2147385342, 4294721535, 4294451199, 4278288639, 4278706431, 4278189951, 4278189951, 4177526559};


const uint32_t picture_wifi_on[13] = {268435456, 134217728, 1275068416, 603979776, 3053453312, 2449539072, 3657629696, 2449539072, 3053453312, 603979776, 1275068416, 134217728, 268435456};
const uint32_t picture_wifi_off[13] = {0, 0, 1879179264, 2348875776, 2214658048, 1107427328, 570556416, 302120960, 201392128, 2348875776, 1912602624, 0, 0};

void add_picture_wifi(uint32_t picture[])
{
    uint32_t position = 63;

    for (uint32_t i = 0; i < 13; i++) {
        buffer[128 * 0 + i + position] = ((picture[i]&0xff000000) >> 24);
        buffer[128 * 1 + i + position] = ((picture[i]&0xff0000) >> 16);
        buffer[128 * 2 + i + position] = ((picture[i]&0xff00) >> 8);
        buffer[128 * 3 + i + position] = ((picture[i]&0xff) >> 0);
    }
}

void add_picture(uint32_t position, uint32_t picture[])
{
    switch (position) {
    case 1: position = 0;
        break;
    case 2: position = 44;
        break;
    case 3: position = 88;
        break;
    default: position = 0;
    }
    for (uint32_t i = 0; i < 40; i++) {
        buffer[128 * 4 + i + position] = ((picture[i]&0xff000000) >> 24);
        buffer[128 * 5 + i + position] = ((picture[i]&0xff0000) >> 16);
        buffer[128 * 6 + i + position] = ((picture[i]&0xff00) >> 8);
        buffer[128 * 7 + i + position] = ((picture[i]&0xff) >> 0);
    }
}
